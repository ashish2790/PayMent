create or replace 
PROCEDURE TCH_REVERSAL_PROC(
  I_TERMINAL_SERIAL_NUMBER IN VARCHAR2
, I_CLIENT_ID IN VARCHAR2
, I_REF_VALUE IN VARCHAR2
, I_INVOICE_NUMBER IN VARCHAR2
, I_BIN_NUMBER IN VARCHAR2
, O_MERCHANT_ID OUT VARCHAR2
, O_TERMINAL_ID OUT VARCHAR2
, O_REV_COUNT OUT VARCHAR2
, O_DEBUG_POINT OUT VARCHAR2  
, O_TABLE_ID OUT VARCHAR2  
, O_SQL_CODE OUT VARCHAR2
, O_BANK_CODE OUT VARCHAR2
, O_APP_ERROR_CODE OUT VARCHAR2
, C_PAYMENT_DETAIL OUT SYS_REFCURSOR
)
AS 
V_COUNT VARCHAR2(4):=NULL;
V_TERMPARAMID VARCHAR(15):=NULL;
V_TABLE_NAME VARCHAR2(10):=NULL;
V_PINBYPASS VARCHAR2(1):=NULL;
V_LABEL VARCHAR(20):=NULL;
BEGIN
  
  O_DEBUG_POINT:='1';
-- GET THE MID TID
     SELECT  H_CARD_ACQUIRING_ID, H_TID INTO O_MERCHANT_ID, O_TERMINAL_ID FROM TCH_HANDSHAKES 
       WHERE H_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER;
       
-- GET BANK CODE
      SELECT THM.BANKCODE INTO O_BANK_CODE FROM TC_TID_HWSR_MAPPING THM WHERE 
       THM.HWSRNO = I_TERMINAL_SERIAL_NUMBER AND THM.MID = O_MERCHANT_ID AND THM.TID = O_TERMINAL_ID;
        
-- GET REVERSAL COUNT 
    SELECT AC_VALUE INTO O_REV_COUNT FROM TCH_APPL_CONFIG WHERE AC_NAME = 'REVCNT';
-- GET THE ORIGINAL TRANSACTION  
  SELECT COUNT(1) INTO V_COUNT FROM TCH_PAYMENT_TXN TPT 
    WHERE TPT.P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER 
    AND P_INVOICENUMBER = I_INVOICE_NUMBER
    AND P_REQUEST_TYPE <> 'REVERSAL';
  
  IF V_COUNT <> 1 THEN
    BEGIN
    SELECT COUNT(1) INTO V_COUNT FROM TCH_PAYMENT_AMEX_TXN TPT 
    WHERE TPT.P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER 
    AND P_INVOICENUMBER = I_INVOICE_NUMBER
    AND P_REQUEST_TYPE <> 'REVERSAL';
    IF V_COUNT <> 1 THEN
      O_DEBUG_POINT:='1A';
    RAISE_APPLICATION_ERROR('-21111','NO DATA FOUND');
    END IF;
     OPEN C_PAYMENT_DETAIL FOR
          SELECT * FROM TCH_PAYMENT_TXN 
          WHERE P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER 
          AND P_INVOICENUMBER = I_INVOICE_NUMBER
          AND P_REQUEST_TYPE <> 'REVERSAL';
    END;
  ELSE
    BEGIN
      O_DEBUG_POINT:='1B';
      IF I_INVOICE_NUMBER <> 'N' THEN
        SELECT COUNT(1) INTO V_COUNT FROM TCH_PAYMENT_TXN 
        WHERE P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER 
        AND P_INVOICENUMBER = I_INVOICE_NUMBER
        AND P_REQUEST_TYPE <> 'REVERSAL';
          IF V_COUNT <> 0 THEN
            OPEN C_PAYMENT_DETAIL FOR
              SELECT * FROM TCH_PAYMENT_TXN 
              WHERE P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER 
              AND P_INVOICENUMBER = I_INVOICE_NUMBER
              AND P_REQUEST_TYPE <> 'REVERSAL';
          ELSE 
            O_DEBUG_POINT:='1BB';
            RAISE_APPLICATION_ERROR('-21111','NO DATA FOUND');
          END IF;
      ELSIF I_REF_VALUE  <> 'N' THEN
         SELECT COUNT(1) INTO V_COUNT FROM TCH_PAYMENT_TXN 
         WHERE P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER 
         AND P_REFERENCE_VALUE = I_REF_VALUE;
        IF V_COUNT <> 0 THEN
          OPEN C_PAYMENT_DETAIL FOR
            SELECT * FROM TCH_PAYMENT_TXN WHERE P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER
            AND P_REFERENCE_VALUE = I_REF_VALUE
            AND P_REQUEST_TYPE <> 'REVERSAL';
        ELSE 
          O_DEBUG_POINT:='1BA';
          RAISE_APPLICATION_ERROR('-21111','NO DATA FOUND');
        END IF;
      END IF;
     END;
   END IF;
  
   O_DEBUG_POINT:='3';
    
    SELECT COUNT(1) INTO V_COUNT FROM TC_TERM_PARAMETER TTP JOIN TC_TID_HWSR_MAPPING THM ON TTP.MID = THM.MID AND TTP.TID = THM.TID 
    JOIN TC_ME_PARAMETER TMP ON  TMP.MEPARAMID = TTP.MEPARAMID 
    WHERE THM.HWSRNO = I_TERMINAL_SERIAL_NUMBER;
    IF V_COUNT = 0 THEN
      BEGIN
        O_DEBUG_POINT:='3A';
        RAISE_APPLICATION_ERROR(-20121,'NO MAPPING FOUND IN INSIGHT');
      END;
    ELSE 
      BEGIN
    
        O_DEBUG_POINT:='4';
        V_TERMPARAMID:=TCH_BIN_VALIDATION(I_BIN_NUMBER,I_TERMINAL_SERIAL_NUMBER);
        IF V_TERMPARAMID IS NULL THEN
          NULL;
--          O_DEBUG_POINT:='4AB';
--          RAISE_APPLICATION_ERROR(-21001,'INVALID BIN VALUE EXCEPTION');
        ELSE  
          V_TABLE_NAME:=V_TERMPARAMID;
         
          O_DEBUG_POINT:='5';
          IF V_TABLE_NAME LIKE '%T1%' THEN
            V_TERMPARAMID:=SUBSTR(V_TERMPARAMID,4,LENGTH(V_TERMPARAMID));
            O_DEBUG_POINT:='5A';
            SELECT CASE WHEN  TTP.PINPROMPT = '1' THEN 'Y' ELSE 'N' END,TTP.CARD_LABEL INTO V_PINBYPASS,V_LABEL FROM TC_TERM_PARAMETER TTP 
            JOIN TC_TID_HWSR_MAPPING THM ON TTP.MID = THM.MID AND TTP.TID = THM.TID 
              JOIN TC_ME_PARAMETER TMP ON  TMP.MEPARAMID = TTP.MEPARAMID 
              WHERE THM.HWSRNO = I_TERMINAL_SERIAL_NUMBER AND TTP.TERMPARAMID = V_TERMPARAMID;

              O_TABLE_ID:='T1-'||V_PINBYPASS||'-'||V_TERMPARAMID||'-'||V_LABEL;
          ELSE
            O_DEBUG_POINT:='5B';  
            O_TABLE_ID:=V_TERMPARAMID;
          END IF;
        END IF;
      END;
    END IF;
  
        
  O_DEBUG_POINT := '2';
  EXCEPTION
  WHEN NO_DATA_FOUND THEN
    IF O_DEBUG_POINT ='1A' THEN
      O_APP_ERROR_CODE:='R-002';
    ELSIF O_DEBUG_POINT ='1BA' THEN
      O_APP_ERROR_CODE:='R-001';
    ELSIF O_DEBUG_POINT ='1BB' THEN
      O_APP_ERROR_CODE:='R-001';
    END IF;
  WHEN OTHERS THEN
    IF O_DEBUG_POINT ='1A' THEN
      O_APP_ERROR_CODE:='R-002';  
    ELSIF O_DEBUG_POINT ='1BA' THEN
      O_APP_ERROR_CODE:='R-001';
    ELSIF O_DEBUG_POINT ='1BB' THEN
      O_APP_ERROR_CODE:='R-001';
    END IF;
    O_SQL_CODE:=SQLCODE;
END TCH_REVERSAL_PROC;