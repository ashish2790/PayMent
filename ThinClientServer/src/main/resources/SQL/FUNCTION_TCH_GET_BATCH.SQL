create or replace 
FUNCTION GET_BATCH_NUMBER(
I_TERMINAL_SERIAL_NUMBER IN VARCHAR2,
I_MERCHANT_ID IN VARCHAR2,
I_TERMINAL_ID IN VARCHAR2
)
RETURN VARCHAR2 
AS 
V_COUNT NUMBER(4):=NULL;
V_BATCH_NUMBER VARCHAR2(6):=NULL;
V_BATCH_S NUMBER(4):=NULL;
V_BATCH_S1 NUMBER(4):=NULL;
V_DEBUG_POINT VARCHAR2(6):=NULL;
  BEGIN
    BEGIN
      V_DEBUG_POINT := '1';
       SELECT P_BATCH_NUMBER, COUNT(1) INTO V_BATCH_NUMBER, V_COUNT FROM TCH_PAYMENT_TXN WHERE P_MERCHANTID = I_MERCHANT_ID 
        AND P_TERMINALID = I_TERMINAL_ID AND P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER AND P_REQUEST_TYPE <> 'REVERSAL'
        GROUP BY P_BATCH_NUMBER;
        
        V_BATCH_NUMBER:=LPAD(V_BATCH_NUMBER,6,'0');
        EXCEPTION 
          WHEN NO_DATA_FOUND THEN
            IF V_DEBUG_POINT = '1' THEN 
              V_COUNT := 0;
            END IF;
    END;
    IF V_COUNT = 0 THEN
      SELECT COUNT(1) INTO V_COUNT FROM TCH_SETTLED_PAYMENT_TXN WHERE 
      P_MERCHANTID = I_MERCHANT_ID AND 
      P_TERMINALID = I_TERMINAL_ID AND 
      P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER;
      
      IF V_COUNT = 0 THEN
         SELECT COUNT(1) INTO V_COUNT FROM TCH_SETTLED_PAYMENT_RT_VT_TT WHERE 
         P_MERCHANTID = I_MERCHANT_ID AND 
         P_TERMINALID = I_TERMINAL_ID AND 
         P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER;
         
         IF V_COUNT = 0 THEN
            INSERT INTO TCH_BATCH_SUMMARY VALUES (SEQ_TC_BATCH_SUMMARY_ID.NEXTVAL, I_MERCHANT_ID, I_TERMINAL_ID, I_TERMINAL_SERIAL_NUMBER, CURRENT_TIMESTAMP,NULL,'0');
            V_BATCH_NUMBER :=  LPAD('1',6,'0');
         ELSE
            SELECT P_BATCH_NUMBER INTO V_BATCH_NUMBER FROM TCH_SETTLED_PAYMENT_RT_VT_TT WHERE 
            P_MERCHANTID = I_MERCHANT_ID AND 
            P_TERMINALID = I_TERMINAL_ID AND 
            P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER
            ORDER BY P_BATCH_NUMBER DESC FETCH FIRST 1 ROWS ONLY;
            
            V_BATCH_NUMBER :=  V_BATCH_NUMBER + 1;
            V_BATCH_NUMBER := LPAD(V_BATCH_NUMBER,6,'0');
            INSERT INTO TCH_BATCH_SUMMARY VALUES (SEQ_TC_BATCH_SUMMARY_ID.NEXTVAL, I_MERCHANT_ID, I_TERMINAL_ID, I_TERMINAL_SERIAL_NUMBER, CURRENT_TIMESTAMP,NULL,'0');
         END IF;
      ELSE
        BEGIN
          SELECT P_BATCH_NUMBER INTO V_BATCH_S FROM TCH_SETTLED_PAYMENT_TXN WHERE 
          P_MERCHANTID = I_MERCHANT_ID AND 
          P_TERMINALID = I_TERMINAL_ID AND 
          P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER
          ORDER BY P_BATCH_NUMBER DESC FETCH FIRST 1 ROWS ONLY;
              
          BEGIN
              V_DEBUG_POINT := '6ZG';
              SELECT P_BATCH_NUMBER INTO V_BATCH_S1 
              FROM TCH_SETTLED_PAYMENT_RT_VT_TT WHERE 
              P_MERCHANTID = I_MERCHANT_ID AND 
              P_TERMINALID = I_TERMINAL_ID AND 
              P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER
              ORDER BY P_BATCH_NUMBER DESC FETCH FIRST 1 ROWS ONLY;
              
              EXCEPTION 
              WHEN NO_DATA_FOUND THEN
                IF V_DEBUG_POINT = '6ZG' THEN
                  V_BATCH_S1:=0;
                END IF;
            END;
          IF V_BATCH_S < V_BATCH_S1 THEN
            V_BATCH_NUMBER := V_BATCH_S1;
          ELSE
            V_BATCH_NUMBER := V_BATCH_S;
          END IF;
              
          V_BATCH_NUMBER :=  V_BATCH_NUMBER + 1;
          INSERT INTO TCH_BATCH_SUMMARY VALUES (SEQ_TC_BATCH_SUMMARY_ID.NEXTVAL, I_MERCHANT_ID, I_MERCHANT_ID, I_TERMINAL_SERIAL_NUMBER, CURRENT_TIMESTAMP,NULL,V_BATCH_NUMBER);
          V_BATCH_NUMBER := LPAD(V_BATCH_NUMBER,6,'0');
        END;
      END IF;
    END IF;
        
    RETURN V_BATCH_NUMBER;
END GET_BATCH_NUMBER;