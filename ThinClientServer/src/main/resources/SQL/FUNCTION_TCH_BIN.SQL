create or replace 
FUNCTION TCH_BIN_VALIDATION
(
  BINVAL IN VARCHAR2,  
  TERM_SERIAL_NUMBER IN VARCHAR2
)   

RETURN VARCHAR2 
AS 
V_PRESENT VARCHAR2(20):=NULL;
V_BIN VARCHAR2(15):=NULL;
V_BIN_LIMIT VARCHAR2(10):=NULL;
--DECLARE FOR JCB UPI
  TYPE BINRANGE_JCBUPI IS RECORD 
  (ID1 TCH_JCBUPI_BIN.ID%TYPE, 
  BIN_RANGE_HIGH TCH_JCBUPI_BIN.BIN_RANGE_HIGH%TYPE, 
      BIN_RANGE_LOW TCH_JCBUPI_BIN.BIN_RANGE_LOW%TYPE,
      PIN_BYPASS_FLAG TCH_JCBUPI_BIN.PIN_BYPASS_FLAG%TYPE,
      SCHEME_CODE TCH_JCBUPI_BIN.SCHEME_CODE%TYPE);
      
  TYPE TCH_BINRANGE_TYPE IS TABLE OF BINRANGE_JCBUPI;
  BIN_RANGES TCH_BINRANGE_TYPE;
  
  CURSOR BINS IS 
  SELECT ID,BIN_RANGE_HIGH,BIN_RANGE_LOW,PIN_BYPASS_FLAG,SCHEME_CODE FROM TCH_JCBUPI_BIN;

--DECLARE FOR NORMAL BIN RANGE
  TYPE BINRANGE_NORMAL IS RECORD 
  (TERMPARAMID TC_TERM_PARAMETER.TERMPARAMID%TYPE,
    CARD_RANGE_HIGH TC_TERM_PARAMETER.CARD_RANGE_HIGH%TYPE,
     CARD_RANGE_LOW TC_TERM_PARAMETER.CARD_RANGE_LOW%TYPE
     );
      
  TYPE TCH_BINRANGE_NORMAL IS TABLE OF BINRANGE_NORMAL;
  BIN_NORMAL_RANGES TCH_BINRANGE_NORMAL;
  
  CURSOR BINS_NORMAL IS 
  SELECT TTP.TERMPARAMID, TTP.CARD_RANGE_HIGH, TTP.CARD_RANGE_LOW FROM TC_TID_HWSR_MAPPING THM JOIN TC_TERM_PARAMETER TTP 
  ON THM.MID = TTP.MID AND TTP.TID = THM.TID
  WHERE THM.HWSRNO = TERM_SERIAL_NUMBER;
  
BEGIN
  SELECT AC_VALUE INTO V_BIN_LIMIT FROM TCH_APPL_CONFIG WHERE AC_NAME = 'BIN';
 IF V_PRESENT IS NULL THEN
       BEGIN
        V_BIN:=SUBSTR(BINVAL,0,TO_NUMBER(9));
        OPEN BINS;
          LOOP
            FETCH BINS BULK COLLECT INTO BIN_RANGES LIMIT 3000;
              FOR INDX IN 1..BIN_RANGES.LAST LOOP
                  BEGIN 
                    IF TO_NUMBER(BIN_RANGES(INDX).BIN_RANGE_HIGH) >= TO_NUMBER(V_BIN) AND TO_NUMBER(BIN_RANGES(INDX).BIN_RANGE_LOW) <= TO_NUMBER(V_BIN) THEN
                      V_PRESENT := 'T2-'||BIN_RANGES(INDX).PIN_BYPASS_FLAG||'-'||BIN_RANGES(INDX).SCHEME_CODE;
                    END IF;
                  END;
               END LOOP;
               EXIT WHEN BINS%NOTFOUND;
          END LOOP;
        CLOSE BINS;
      END;
    END IF;
 
 --CHECK IN NORMAL BIN RANGE
 IF V_PRESENT IS NULL THEN
 V_BIN:=SUBSTR(BINVAL,0,TO_NUMBER(V_BIN_LIMIT));
      OPEN BINS_NORMAL;
        LOOP
          FETCH BINS_NORMAL BULK COLLECT INTO BIN_NORMAL_RANGES LIMIT 3000;
            FOR INDXX IN 1..BIN_NORMAL_RANGES.LAST LOOP
              IF TO_NUMBER(BIN_NORMAL_RANGES(INDXX).CARD_RANGE_HIGH) >= TO_NUMBER(V_BIN) AND TO_NUMBER(BIN_NORMAL_RANGES(INDXX).CARD_RANGE_LOW) <= TO_NUMBER(V_BIN) THEN
                BEGIN
                  V_PRESENT := 'T1-'||BIN_NORMAL_RANGES(INDXX).TERMPARAMID;
                END;
              END IF;
            END LOOP;
          EXIT WHEN BINS_NORMAL%NOTFOUND;
        END LOOP;
      CLOSE BINS_NORMAL;
--CHECK IN JCB UPI TABLE
 END IF;

     
  RETURN V_PRESENT;
END TCH_BIN_VALIDATION;