create or replace 
PROCEDURE TCH_PREAUTH_COMP_PROC 
(
  I_TERMINAL_SERIAL_NUMBER IN VARCHAR2  
, I_RETRIVAL_REF_NUMBER IN VARCHAR2
, I_BIN_NUMBER1 IN VARCHAR2
, O_SQL_CODE OUT VARCHAR2
, O_APP_ERROR_CODE OUT VARCHAR2
, O_DEBUG_POINT OUT VARCHAR2 
, O_TABLE_ID OUT VARCHAR2
, O_BATCH_NUMBER OUT VARCHAR2
, O_PREAUTH_PER OUT NUMBER
) AS 

V_COUNT NUMBER(4):=NULL ; 
V_MID VARCHAR(20):=NULL;
V_HWSR_MID VARCHAR(20):=NULL;
V_DAYS NUMBER(3):=NULL;
V_PREAUTH_DATE DATE:=NULL;
V_TODAY_DATE DATE:=SYSDATE;
V_CALCULATED_DAYS NUMBER(3):=NULL;
V_STATUS VARCHAR2(2):=NULL;
V_TID VARCHAR(20):=NULL;
V_TERMPARAMID VARCHAR(15):='ASD';
V_TABLE_NAME VARCHAR2(15):=NULL;
BEGIN
--GET THE STATUS WHETHER TERMINAL IS ACTIVE OR NOT
      O_DEBUG_POINT:='0';
      SELECT STATUS INTO V_STATUS FROM TC_TID_HWSR_MAPPING WHERE HWSRNO = I_TERMINAL_SERIAL_NUMBER;
      IF V_STATUS = 'D' THEN
        BEGIN
          RAISE_APPLICATION_ERROR('-20121','TERMINAL IS DEACTIVATED');
        END;
      END IF;

-- GET THE DETAILS FOR PREAUTH AND TEST MID AGAINST TERMINAL SERIAL NUMBER
    O_DEBUG_POINT := '1';
      BEGIN 
        SELECT COUNT(1),TPAT.P_MERCHANTID,TPAT.P_TERMINALID INTO 
        V_COUNT,V_MID,V_TID FROM TCH_PAYMENT_AUTH_TXN TPAT 
        WHERE TPAT.P_RETRIVAL_REF_NUMBER = I_RETRIVAL_REF_NUMBER 
        GROUP BY TPAT.P_MERCHANTID,TPAT.P_TERMINALID;
        
        EXCEPTION
          WHEN NO_DATA_FOUND THEN
          IF O_DEBUG_POINT = '1' THEN
            V_COUNT:=0;
          END IF;
          WHEN OTHERS THEN
          IF O_DEBUG_POINT = '1' THEN
            V_COUNT:=0;
          END IF;
      END;
    IF V_COUNT = 0 THEN
      BEGIN
        O_DEBUG_POINT:='1A';
        RAISE_APPLICATION_ERROR(-20001,'NO MAPPING FOUND');
      END;
    ELSE
      BEGIN
        O_DEBUG_POINT:='1B';
        SELECT TPAT.P_MERCHANTID, TPAT.P_CREATED INTO V_MID, V_PREAUTH_DATE FROM TCH_PAYMENT_AUTH_TXN TPAT
        WHERE TPAT.P_RETRIVAL_REF_NUMBER = I_RETRIVAL_REF_NUMBER 
        AND P_REQUEST_TYPE = 'PREAUTH';    
        
        O_DEBUG_POINT:='1C';
        SELECT THM.MID INTO V_HWSR_MID FROM TC_TID_HWSR_MAPPING THM 
        WHERE THM.HWSRNO = I_TERMINAL_SERIAL_NUMBER;
        O_DEBUG_POINT:='1D';
--        IF V_MID <> V_HWSR_MID THEN
--          BEGIN
--            O_DEBUG_POINT:='1E';
--            RAISE_APPLICATION_ERROR(-20002,'MID MISS MATCH EXCEPTION');
--          END;
--        END IF;
      END;
    END IF;
  O_DEBUG_POINT:='2';
    
-- CHECK FOR DATE IS VALID FOR COMPLETION OR NOT
    SELECT AC_VALUE INTO V_DAYS FROM TCH_APPL_CONFIG WHERE AC_NAME = 'PREAUTHDAYS';
    V_CALCULATED_DAYS := V_TODAY_DATE - V_PREAUTH_DATE;
  
    
    IF V_CALCULATED_DAYS > V_DAYS THEN
      O_DEBUG_POINT:='2A';
      RAISE_APPLICATION_ERROR(-20002,'DATE HAS GONE AWAY FOR COMPLETION');
    END IF;

--GET BATCH NUMBER
  O_BATCH_NUMBER := GET_BATCH_NUMBER(I_TERMINAL_SERIAL_NUMBER,V_MID,V_TID);
    O_DEBUG_POINT:='3';

-- GET BIN VALIDATION
--   BEGIN 
--        O_DEBUG_POINT:='4';
--       V_TERMPARAMID:=TCH_BIN_VALIDATION(I_BIN_NUMBER1,I_TERMINAL_SERIAL_NUMBER);
--        IF V_TERMPARAMID IS NULL THEN
--          O_DEBUG_POINT:='4AB';
--          RAISE_APPLICATION_ERROR('-20122','INVALID BIN VALUE EXCEPTION');
--        ELSE  
--          V_TABLE_NAME:=V_TERMPARAMID;
--         
--          O_DEBUG_POINT:='5';
--          IF V_TABLE_NAME LIKE '%T1%' THEN
--            V_TERMPARAMID:=SUBSTR(V_TERMPARAMID,4,LENGTH(V_TERMPARAMID));
--            O_DEBUG_POINT:='5A';
--            O_TABLE_ID:='T1-N-'||V_TERMPARAMID;
--          ELSE
--            O_DEBUG_POINT:='5B';  
--            O_TABLE_ID:=V_TERMPARAMID;
--          END IF;
--        END IF;
--      END;

--  GET PERCENT VALUE BANKWISE
    SELECT B_PREAUTH_PER INTO O_PREAUTH_PER FROM TCH_BANK_MASTER TBM JOIN TC_TID_HWSR_MAPPING THM
    ON TBM.B_BANKCODE = THM.BANKCODE 
    WHERE THM.HWSRNO = I_TERMINAL_SERIAL_NUMBER;
   O_DEBUG_POINT:='6';
  
    EXCEPTION
      WHEN NO_DATA_FOUND THEN 
        IF O_DEBUG_POINT = '1E' THEN
          O_APP_ERROR_CODE:='P-011';
        ELSIF O_DEBUG_POINT = '1A' THEN
          O_APP_ERROR_CODE:='P-007';
        END IF;
      WHEN OTHERS THEN
        IF O_DEBUG_POINT = '0' THEN
          O_APP_ERROR_CODE:='Z-010';
        ELSIF O_DEBUG_POINT = '1E' THEN
          O_APP_ERROR_CODE:='P-011';
        ELSIF O_DEBUG_POINT = '1E' THEN
          O_APP_ERROR_CODE:='P-007';
       ELSIF O_DEBUG_POINT = '2A' THEN
          O_APP_ERROR_CODE:='P-012';
       ELSIF O_DEBUG_POINT = '1A' THEN
          O_APP_ERROR_CODE:='P-007';        
       END IF;
        O_SQL_CODE := SQLCODE; 
  END TCH_PREAUTH_COMP_PROC;