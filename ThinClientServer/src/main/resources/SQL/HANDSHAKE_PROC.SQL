create or replace 
PROCEDURE TCH_HANDSHAKE_PROC 
(
  I_TERMINAL_SERIAL_NUMBER IN VARCHAR2 
, I_SETTLEMENT_FLAG IN VARCHAR2
, O_CLIEND_ID OUT VARCHAR2  
, O_STRACE_NUMBER OUT VARCHAR2
, O_SQL_CODE OUT VARCHAR2
, O_APP_ERROR_CODE OUT VARCHAR2
, O_DEBUG_POINT OUT VARCHAR2 
, O_EXISTING_HSK OUT NUMBER
, O_INV_NUMBER OUT VARCHAR2
, O_STAN_NUMBER OUT VARCHAR2
, O_HEALTH_OBJ_PARAM OUT VARCHAR2
, C_HANDSHAKE_DETAILS OUT SYS_REFCURSOR
, C_CARD_OBJECTS OUT SYS_REFCURSOR
, C_UTILITY_INFO OUT SYS_REFCURSOR
) AS 

V_CLIENT_ID VARCHAR2(20):= NULL;
V_COUNT NUMBER(4) :=NULL; 
V_STATUS VARCHAR2(1):=NULL;
V_MID VARCHAR2(20):=NULL;
V_TID VARCHAR2(20):=NULL;

BEGIN

  O_DEBUG_POINT:='1';
  SELECT COUNT(1) INTO V_COUNT FROM TCH_HANDSHAKES 
  WHERE H_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER; 
  
  IF V_COUNT = 1 THEN 
      O_DEBUG_POINT:='2A';
      SELECT H_CLIENT_ID , H_ID  INTO V_CLIENT_ID,  O_EXISTING_HSK  FROM TCH_HANDSHAKES 
      WHERE H_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER;         
      O_CLIEND_ID := V_CLIENT_ID;
  ELSE
      O_DEBUG_POINT:='2B';
      
      SELECT COUNT(1) INTO V_COUNT FROM TC_TID_HWSR_MAPPING THM WHERE THM.HWSRNO = I_TERMINAL_SERIAL_NUMBER  ;
      IF V_COUNT <> 1 THEN
        O_DEBUG_POINT:='2BA';
        RAISE_APPLICATION_ERROR('-21211','INCORRECT ENTRIES FOUND');
      END IF;
      
      SELECT COUNT(1) INTO V_COUNT FROM TC_TERM_PARAMETER TTP JOIN TC_TID_HWSR_MAPPING THM ON TTP.MID = THM.MID AND TTP.TID = THM.TID 
      JOIN TC_ME_PARAMETER TMP ON  TMP.MEPARAMID = TTP.MEPARAMID 
      WHERE THM.HWSRNO = I_TERMINAL_SERIAL_NUMBER ;
      
      IF V_COUNT = 0 THEN 
          RAISE_APPLICATION_ERROR(-20201, 'NO MAPPING FOUND IN INSIGHT DB');
      END IF ;
      
      O_DEBUG_POINT:='2C';
      SELECT SEQ_TC_HSK_CLIENDID.NEXTVAL INTO O_CLIEND_ID FROM DUAL ;
      O_CLIEND_ID := 'TC' || LPAD(O_CLIEND_ID,13,'0');  
      O_EXISTING_HSK:=null;
  END IF;
  
  O_DEBUG_POINT:='3';
  SELECT SEQ_TC_HSK_STRACE.NEXTVAL INTO O_STRACE_NUMBER FROM DUAL ;
      O_STRACE_NUMBER :=  LPAD(O_STRACE_NUMBER,6,'0'); 
      
     O_DEBUG_POINT:='3A';
    SELECT THM.STATUS INTO V_STATUS FROM TC_TID_HWSR_MAPPING THM 
    WHERE THM.HWSRNO = I_TERMINAL_SERIAL_NUMBER AND THM.STATUS = 'A'; 
    IF V_STATUS <> NULL THEN
      IF V_STATUS = 'D' THEN
        RAISE_APPLICATION_ERROR('-20111','TERMINAL IS DEACTIVATED');
      END IF;
    END IF;
    O_DEBUG_POINT:='4';
  OPEN C_HANDSHAKE_DETAILS FOR
    SELECT THM.TID, TTP.TPDU, THM.MID, TTP.NII, THM.LINEENC, TMP.BANKNAME, TMP.DBANAME, TMP.LOCATION, THM.UPIFLAG, THM.WALLETFLAG,
    TMP.LEGALNAME, THM.REFUNDNEW, TTP.RELOAD, THM.CASHBACK, TTP.BAL_INQ_ALWD, THM.CASHBACKPUR, THM.ADJUSTMENT,TMP.MEPARAMID,    
    THM.AUTOSETTLEMENT, THM.PREAUTH, TTP.OUTLETCODE, TTP.OUTLETNAME, TTP.BILLERNAME, THM.LASTFOURDIGIT,THM.RECEIPTFLAG,THM.BANKCODE,
    TTP.SE_NUMBER,TTP.DCCFLAG,TTP.DCCTID,TTP.DCCMID
    FROM TC_TERM_PARAMETER TTP JOIN TC_TID_HWSR_MAPPING THM ON TTP.MID = THM.MID AND TTP.TID = THM.TID 
    JOIN TC_ME_PARAMETER TMP ON  TMP.MEPARAMID = TTP.MEPARAMID 
    WHERE THM.HWSRNO = I_TERMINAL_SERIAL_NUMBER ; 
  
  O_DEBUG_POINT:='5'; 
  OPEN  C_CARD_OBJECTS FOR
    SELECT  TTP.CARD_RANGE_LOW , TTP.CARD_RANGE_HIGH , TTP.PINPROMPT , TTP.CARD_TYPE 
    FROM TC_TERM_PARAMETER TTP JOIN TC_TID_HWSR_MAPPING THM ON TTP.MID = THM.MID AND TTP.TID = THM.TID 
    WHERE THM.HWSRNO = I_TERMINAL_SERIAL_NUMBER ;
    
  O_DEBUG_POINT:= '6'; 
-- CHECK FOR PREVIOUS BATCH IS SETTLE OR NOT
    IF I_SETTLEMENT_FLAG = 'Y' THEN
      BEGIN
         SELECT COUNT(1) INTO V_COUNT FROM TCH_PAYMENT_TXN TTP JOIN TCH_HANDSHAKES TH ON TTP.P_MERCHANTID = TH.H_CARD_ACQUIRING_ID
            AND TTP.P_TERMINALID = TH.H_TID AND TTP.P_CLIENTID = TH.H_CLIENT_ID
            WHERE TTP.P_RESPONSE_CODE='00' 
            AND TTP.P_SETTLEMENT_FLAG = 'N'
            AND TTP.P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER;
            
        IF V_COUNT <> 0 THEN
          BEGIN
            O_DEBUG_POINT := '6A';
            RAISE_APPLICATION_ERROR('-20111','NEED TO SETTLE BATCH FIRST');
          END;
        END IF;
          O_DEBUG_POINT:= '7';
      END;
    END IF;
    
 --GET INVOICE NUMBER AND STAN NUMBER 
 
    SELECT MID, TID INTO V_MID, V_TID FROM TC_TID_HWSR_MAPPING WHERE HWSRNO = I_TERMINAL_SERIAL_NUMBER;
 
    SELECT COUNT(1) INTO V_COUNT FROM TCH_PAYMENT_TXN 
        WHERE P_MERCHANTID = V_MID AND P_TERMINALID = V_TID AND P_SETTLEMENT_FLAG = 'N' AND P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER;
        
    IF V_COUNT = 0 THEN
         SELECT COUNT(1) INTO V_COUNT FROM TCH_SETTLED_PAYMENT_TXN 
           WHERE P_MERCHANTID = V_MID AND P_TERMINALID = V_TID AND P_SETTLEMENT_FLAG = 'Y' AND P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER;
        IF V_COUNT <> 0 THEN
          BEGIN
           SELECT P_INVOICENUMBER INTO O_INV_NUMBER   FROM TCH_SETTLED_PAYMENT_TXN 
            WHERE P_MERCHANTID = V_MID AND P_TERMINALID = V_TID AND P_SETTLEMENT_FLAG = 'Y'  AND P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER 
            ORDER BY P_INVOICENUMBER DESC FETCH FIRST 1 ROWS ONLY;
            
            SELECT P_STAN_NUMBER INTO O_STAN_NUMBER   FROM TCH_SETTLED_PAYMENT_TXN 
            WHERE P_MERCHANTID = V_MID AND P_TERMINALID = V_TID AND P_SETTLEMENT_FLAG = 'Y'  AND P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER 
            ORDER BY P_STAN_NUMBER DESC FETCH FIRST 1 ROWS ONLY;
          END;
        END IF;
    ELSIF V_COUNT <> 0 THEN
      BEGIN
        SELECT P_INVOICENUMBER INTO O_INV_NUMBER   FROM TCH_PAYMENT_TXN 
           WHERE P_MERCHANTID = V_MID AND P_TERMINALID = V_TID AND P_SETTLEMENT_FLAG = 'N'  AND P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER
            ORDER BY P_INVOICENUMBER DESC FETCH FIRST 1 ROWS ONLY;
            
        SELECT P_STAN_NUMBER INTO O_STAN_NUMBER   FROM TCH_PAYMENT_TXN 
           WHERE P_MERCHANTID = V_MID AND P_TERMINALID = V_TID AND P_SETTLEMENT_FLAG = 'N'  AND P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER
            ORDER BY P_STAN_NUMBER DESC FETCH FIRST 1 ROWS ONLY;
      END;
    END IF;
-- GET UTILITY RELATED INFO
  OPEN C_UTILITY_INFO FOR
    SELECT * FROM TCH_UTILITY_CONFIG;

--GET INFO FOR HEALTH OBJECT
  SELECT COUNT(1) INTO V_COUNT FROM TCH_HEALTH_OBJECT WHERE TERMINAL_SERIAL_NUMBER  = I_TERMINAL_SERIAL_NUMBER;
  
  IF V_COUNT <> 0 THEN
    O_HEALTH_OBJ_PARAM:='P';
  ELSE
    O_HEALTH_OBJ_PARAM:='A';
  END IF;
 
  
  EXCEPTION
    WHEN NO_DATA_FOUND THEN 
      IF O_DEBUG_POINT = '4' THEN 
          O_APP_ERROR_CODE := 'H-004';
      ELSIF O_DEBUG_POINT = '2BA' THEN 
          O_APP_ERROR_CODE := 'H-008';
      ELSIF O_DEBUG_POINT = '5' THEN 
          O_APP_ERROR_CODE :=  'H-005';
      END IF;
    WHEN TOO_MANY_ROWS THEN 
        IF O_DEBUG_POINT = '2A' THEN 
          O_APP_ERROR_CODE := 'H-001'; 
        END IF ;
    WHEN OTHERS THEN
      IF O_DEBUG_POINT = '2BA' THEN 
          O_APP_ERROR_CODE := 'H-008';
      ELSIF O_DEBUG_POINT ='3A' THEN
          O_APP_ERROR_CODE:='Z-010';
      ELSIF O_DEBUG_POINT = '2B' THEN 
          O_APP_ERROR_CODE := 'H-004'; 
      ELSIF O_DEBUG_POINT = '6A' THEN
          O_APP_ERROR_CODE := 'H-006';
      ELSE 
          O_APP_ERROR_CODE:='H-001';
      END IF ;      
      O_SQL_CODE := SQLCODE; 
  
END TCH_HANDSHAKE_PROC;