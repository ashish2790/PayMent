create or replace 
PROCEDURE TCH_PAYMENT_SALE1_PROC 
(
  I_TERMINAL_SERIAL_NUMBER IN VARCHAR2  
, I_APP_NAME IN VARCHAR2
, I_BIN_NUMBER IN VARCHAR2
, O_MERCHANT_ID OUT VARCHAR2  
, O_TERMINAL_ID OUT VARCHAR2
, O_TERMINAL_SWAPP OUT VARCHAR2
, O_CLIENT_ID OUT VARCHAR2
, O_BATCH_NUMBER OUT VARCHAR2
, O_SQL_CODE OUT VARCHAR2
, O_APP_ERROR_CODE OUT VARCHAR2
, O_DEBUG_POINT OUT VARCHAR2 
, O_TXN_COUNT OUT VARCHAR2
, O_DAILY_LIMIT OUT VARCHAR2
, O_RTM_FLAG OUT NUMBER
, O_DOWNLOAD_TIME OUT VARCHAR2
, O_TABLE_ID OUT VARCHAR2
, O_BANK_CODE OUT VARCHAR2
, O_SUMM_FLAG OUT VARCHAR2
, O_BIN_INFO OUT VARCHAR2
, C_TERMINAL_PARAM OUT SYS_REFCURSOR
, C_APP_CONFIG OUT SYS_REFCURSOR
, C_HEALTH_OBJECT OUT SYS_REFCURSOR
, C_UTILITY_INFO OUT SYS_REFCURSOR
) AS 

TYPE TCH_STRING_ARRAY IS VARRAY (500) OF VARCHAR2(10);

V_CLIENT_ID VARCHAR2(20):= NULL;
V_PINBYPASS VARCHAR2(1):=NULL;
V_STATUS VARCHAR2(2):=NULL;
V_COUNT NUMBER(20):=NULL; 
V_MID VARCHAR(20):=NULL;
V_TID VARCHAR(20):=NULL;
V_BATCH_S NUMBER(4):=NULL;
V_BATCH_S1 NUMBER(4):=NULL;
V_SE_NUMBER NUMBER(30):=NULL;
V_TERMPARAMID VARCHAR(20):=NULL;
V_PID TCH_STRING_ARRAY;
V_TABLE_NAME VARCHAR2(20):=NULL;
V_LASTBUTONE_COUNT VARCHAR2(20):=NULL;

BEGIN
--GET THE STATUS WHETHER TERMINAL IS ACTIVE OR NOT
      O_DEBUG_POINT:='0';
      SELECT STATUS,BANKCODE INTO V_STATUS,O_BANK_CODE FROM TC_TID_HWSR_MAPPING WHERE HWSRNO = I_TERMINAL_SERIAL_NUMBER AND STATUS = 'A';
      IF V_STATUS = 'D' THEN
        BEGIN
          RAISE_APPLICATION_ERROR('-20121','TERMINAL IS DEACTIVATED');
        END;
      END IF;


 -- GET THE CLIENT ID FROM HANDSHAKE 
      O_DEBUG_POINT:='1';
      SELECT COUNT(1) INTO V_COUNT FROM TCH_HANDSHAKES 
      WHERE H_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER;
      
      IF V_COUNT = 1 THEN
        BEGIN 
          O_DEBUG_POINT := '1A';
          
          SELECT H_CLIENT_ID, H_CARD_ACQUIRING_ID, H_TID INTO V_CLIENT_ID, O_MERCHANT_ID, O_TERMINAL_ID FROM TCH_HANDSHAKES 
          WHERE H_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER;
          O_CLIENT_ID := V_CLIENT_ID;
        END;        
      ELSIF V_COUNT = 0 THEN
        BEGIN
          O_DEBUG_POINT:='1B';
          RAISE_APPLICATION_ERROR(-20001,'NO MAPPING FOR HANDSHAKE');
        END;
      END IF;

-- CHECK FOR THE SWAPPING
      O_DEBUG_POINT := '2';
        
      SELECT COUNT(1) INTO  V_COUNT FROM TC_TID_HWSR_MAPPING 
      WHERE HWSRNO = I_TERMINAL_SERIAL_NUMBER AND STATUS = 'A';
      
      IF V_COUNT = '1' THEN
        BEGIN
          O_DEBUG_POINT:='2A';
          SELECT MID, TID INTO  V_MID, V_TID FROM TC_TID_HWSR_MAPPING 
          WHERE HWSRNO = I_TERMINAL_SERIAL_NUMBER AND STATUS = 'A'; 
          IF ((V_MID != O_MERCHANT_ID) OR (V_TID != O_TERMINAL_ID)) THEN
            BEGIN
              O_DEBUG_POINT:='2B';
              RAISE_APPLICATION_ERROR(-20121,'SWAPPING MID TID ISSUE');
            END ;
          END IF;
        END;
      ELSIF V_COUNT <> 1 THEN
        BEGIN
          O_DEBUG_POINT:='2B';
          RAISE_APPLICATION_ERROR(-20201, 'NO MAPPING FOUND IN INSIGHT DB');
        END;
      END IF;
      
-- GET TERMINAL PARAMETER WITH BIN CHECK
    O_DEBUG_POINT:='3';
    
    SELECT COUNT(1) INTO V_COUNT 
    FROM TC_TERM_PARAMETER TTP JOIN TC_TID_HWSR_MAPPING THM 
    ON TTP.MID = THM.MID AND TTP.TID = THM.TID 
    JOIN TC_ME_PARAMETER TMP ON  TMP.MEPARAMID = TTP.MEPARAMID 
    WHERE THM.HWSRNO = I_TERMINAL_SERIAL_NUMBER ;
    IF V_COUNT = 0 THEN
      BEGIN
        O_DEBUG_POINT:='3A';
        RAISE_APPLICATION_ERROR(-20121,'NO MAPPING FOUND IN INSIGHT');
      END;
    ELSE 
      BEGIN 
        O_DEBUG_POINT:='4';
        V_TERMPARAMID:=TCH_BIN_VALIDATION(I_BIN_NUMBER,I_TERMINAL_SERIAL_NUMBER);
        IF V_TERMPARAMID IS NULL THEN
          O_DEBUG_POINT:='4AB';
          RAISE_APPLICATION_ERROR(-21001,'INVALID BIN VALUE EXCEPTION');
        ELSE  
          V_TABLE_NAME:=V_TERMPARAMID;
         
          O_DEBUG_POINT:='5';
          IF V_TABLE_NAME LIKE '%T1%' THEN
            V_TERMPARAMID:=SUBSTR(V_TERMPARAMID,4,LENGTH(V_TERMPARAMID));
            O_DEBUG_POINT:='5A';
            
            OPEN C_TERMINAL_PARAM FOR
              SELECT TTP.* FROM TC_TERM_PARAMETER TTP JOIN TC_TID_HWSR_MAPPING THM ON TTP.MID = THM.MID AND TTP.TID = THM.TID 
              JOIN TC_ME_PARAMETER TMP ON  TMP.MEPARAMID = TTP.MEPARAMID 
              WHERE THM.HWSRNO = I_TERMINAL_SERIAL_NUMBER AND TTP.TERMPARAMID = V_TERMPARAMID;
              O_DEBUG_POINT:='5B';
              
              -- GET AMEX SE NUMBER AND CONVERT IT INTO MID AND TID
               SELECT COUNT(TTP.SE_NUMBER) INTO V_COUNT FROM TC_TERM_PARAMETER TTP 
                 JOIN TC_TID_HWSR_MAPPING THM ON TTP.MID = THM.MID AND TTP.TID = THM.TID 
                 JOIN TC_ME_PARAMETER TMP ON  TMP.MEPARAMID = TTP.MEPARAMID 
                 WHERE THM.HWSRNO = I_TERMINAL_SERIAL_NUMBER 
                 AND TTP.TERMPARAMID = V_TERMPARAMID
                 AND TTP.CARD_LABEL LIKE '%AMEX%' AND ROWNUM = 1;
              IF V_COUNT <> 0 THEN
                BEGIN 
                   SELECT TTP.SE_NUMBER INTO V_SE_NUMBER FROM TC_TERM_PARAMETER TTP 
                   JOIN TC_TID_HWSR_MAPPING THM ON TTP.MID = THM.MID AND TTP.TID = THM.TID 
                   JOIN TC_ME_PARAMETER TMP ON  TMP.MEPARAMID = TTP.MEPARAMID 
                   WHERE THM.HWSRNO = I_TERMINAL_SERIAL_NUMBER 
                   AND TTP.TERMPARAMID = V_TERMPARAMID
                   AND TTP.CARD_LABEL LIKE '%AMEX%' AND ROWNUM = 1;
                --SET AMEX AMID AND TID  
                  IF V_SE_NUMBER IS NOT NULL THEN
                    BEGIN
                      --GET AMEX TID
                      O_TERMINAL_ID := SUBSTR(V_SE_NUMBER,-8); 
                      --GET AMEX MID
                      O_MERCHANT_ID := LPAD(SUBSTR(V_SE_NUMBER,0,(LENGTH(V_SE_NUMBER)-8)),15,0);
                    END;
                  END IF;
                END;
              END IF;
              O_TABLE_ID:='T1-N-'||V_TERMPARAMID;
          ELSE
            O_DEBUG_POINT:='5B';  
            O_TABLE_ID:=V_TERMPARAMID;
            
            OPEN C_TERMINAL_PARAM FOR
              SELECT TTP.* FROM TC_TERM_PARAMETER TTP WHERE TTP.MID = O_MERCHANT_ID AND TTP.TID = O_TERMINAL_ID 
              AND TTP.CARD_LABEL = 'RUPAY'; 
          END IF;
        END IF;
      END;
    END IF;
--GET THE BATCH NUMBER
    O_DEBUG_POINT:='6';
    O_BATCH_NUMBER:= GET_BATCH_NUMBER(I_TERMINAL_SERIAL_NUMBER,O_MERCHANT_ID,O_TERMINAL_ID);      
-- GET THE BIN RANGE VALUE 
    OPEN C_APP_CONFIG FOR
      SELECT * FROM TCH_APPL_CONFIG;
      
 -- GET DAILY TRANSACTION LIMIT
    SELECT DAILY_TXN_COUNT INTO O_DAILY_LIMIT  FROM TC_TID_HWSR_MAPPING WHERE HWSRNO = I_TERMINAL_SERIAL_NUMBER AND STATUS = 'A';
    
--GET THE TRANSACTION COUNT (MAX 100)
    O_DEBUG_POINT:='6AA';
 -- CHECK IN AMEX TABLE TOO IF FOUND EMPTY IN CR DEBIT   
    SELECT SUM(TOTAL_COUNT) INTO O_TXN_COUNT FROM 
    (
      SELECT COUNT(1) AS TOTAL_COUNT FROM TCH_PAYMENT_TXN 
      WHERE P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER
      AND P_REQUEST_TYPE IN ('SALE','VOID','VOIDSALECSHBK','SALECSHBK','CSHBK')
      AND P_RESPONSE_CODE = '00'
       
      UNION ALL
      
      SELECT COUNT(1) AS TOTAL_COUNT FROM TCH_PAYMENT_AMEX_TXN 
        WHERE P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER
        AND P_REQUEST_TYPE IN ('SALE','VOID','VOIDSALECSHBK','SALECSHBK','CSHBK')
        AND P_RESPONSE_CODE = '00'
      );
    
    -- TO SET SUMMARY REPORT FLAG AND SEND SAME TO EDC
    O_TXN_COUNT := TO_NUMBER(O_TXN_COUNT + 1);
    IF TO_NUMBER(O_TXN_COUNT) = TO_NUMBER(O_DAILY_LIMIT) THEN
      O_DEBUG_POINT:='6AAB';
      O_SUMM_FLAG:='1';
    ELSIF  TO_NUMBER(O_TXN_COUNT) > TO_NUMBER(O_DAILY_LIMIT) THEN
      O_SUMM_FLAG:='2';
    END IF;
-- GET THE HEALTHOBJECT BASED ON RTM FLAG
    O_DEBUG_POINT := '6Z';
    SELECT H_RTM_FLAG, H_DWNLD_TM INTO O_RTM_FLAG, O_DOWNLOAD_TIME FROM TCH_HANDSHAKES WHERE H_TERMINAL_SERIAL_NUMBER =  I_TERMINAL_SERIAL_NUMBER;
    IF O_RTM_FLAG = 1 THEN
      BEGIN
        O_DEBUG_POINT := '6ZA';
        OPEN C_HEALTH_OBJECT FOR 
          SELECT * FROM TCH_HEALTH_OBJECT WHERE TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER
          AND TID = O_TERMINAL_ID AND MID = O_MERCHANT_ID;
-- SET INSTALL FLAG AS 'N' FOR RTM DOWNLOAD AVAILABLE
      --  UPDATE TCH_HANDSHAKES SET H_RTM_FLAG = '0' , H_INSTALL_FLAG = 'N' WHERE H_TERMINAL_SERIAL_NUMBER =  I_TERMINAL_SERIAL_NUMBER;
      END;
    END IF;
 -- GET UTILITY INFO
    IF I_APP_NAME IS NOT NULL THEN
      BEGIN 
        OPEN C_UTILITY_INFO FOR
          SELECT U_PRINT_LABELS FROM TCH_UTILITY_INFO WHERE U_APP_NAME = I_APP_NAME;
      END;
    END IF;
-- CHANGES FOR IRCTC
  IF I_APP_NAME = 'IRCTC' THEN
    O_BIN_INFO := TCH_IRCTC_BIN_VALIDATE(I_BIN_NUMBER);
  END IF;
    O_DEBUG_POINT:= '7'; 
      
    EXCEPTION
      WHEN NO_DATA_FOUND THEN 
        IF O_DEBUG_POINT = '1B' THEN 
            O_APP_ERROR_CODE := 'S-999';
        ELSIF O_DEBUG_POINT = '3A' THEN 
            O_APP_ERROR_CODE :=  'S-009';
        ELSIF O_DEBUG_POINT = '4AB' THEN
            O_APP_ERROR_CODE :=  'S-011';
        END IF;
      WHEN TOO_MANY_ROWS THEN 
        IF O_DEBUG_POINT = '2A' THEN 
          O_APP_ERROR_CODE := 'H-001'; 
        ELSIF O_DEBUG_POINT = '4AB' THEN
           O_APP_ERROR_CODE :=  'S-011';
        END IF ;
      WHEN OTHERS THEN
        IF O_DEBUG_POINT = '0' THEN
          O_APP_ERROR_CODE := 'Z-010'; 
        ELSIF O_DEBUG_POINT = '1B' THEN 
            O_APP_ERROR_CODE := 'S-999'; 
        ELSIF O_DEBUG_POINT = '2A' THEN
            O_APP_ERROR_CODE:='S-002';
        ELSIF O_DEBUG_POINT = '2B' THEN
            O_APP_ERROR_CODE:='S-999'; 
        ELSIF O_DEBUG_POINT = '3A' THEN
            O_APP_ERROR_CODE:='S-009';
        ELSIF O_DEBUG_POINT = '4AB' THEN
            O_APP_ERROR_CODE :=  'S-011';
        END IF ;      
        O_SQL_CODE := SQLCODE; 
  END TCH_PAYMENT_SALE1_PROC;