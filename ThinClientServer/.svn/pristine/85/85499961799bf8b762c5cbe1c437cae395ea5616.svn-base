CREATE OR REPLACE PROCEDURE TCH_EMV_ACK(
 I_TERMINAL_SERIAL_NUMBER IN VARCHAR2
, I_FIELD55 IN VARCHAR2
, I_CLIENT_ID IN VARCHAR2 
, I_INVOICE IN VARCHAR2
, I_RRN IN VARCHAR2
, O_APP_ERROR_CODE OUT VARCHAR2
, O_DEBUG_POINT OUT VARCHAR2
, O_SQL_CODE OUT VARCHAR2
) 
AS 
V_COUNT NUMBER(20):=NULL;
BEGIN
  O_DEBUG_POINT:='1';
  
  SELECT COUNT(1) INTO V_COUNT FROM TCH_PAYMENT_TXN 
  WHERE P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER AND P_INVOICENUMBER = I_INVOICE AND P_RETRIVAL_REF_NUMBER = I_RRN 
  AND P_CLIENTID = I_CLIENT_ID;
  
  IF V_COUNT = 0 THEN
    O_DEBUG_POINT:='1A';
    RAISE_APPLICATION_ERROR('-21321','NO DATA FOUND');
  ELSE
    BEGIN
      O_DEBUG_POINT:='2';
      UPDATE TCH_PAYMENT_TXN SET P_FIELD55 = I_FIELD55 WHERE P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER AND P_INVOICENUMBER = I_INVOICE AND P_RETRIVAL_REF_NUMBER = I_RRN 
      AND P_CLIENTID = I_CLIENT_ID;
    END;
  END IF;
  O_DEBUG_POINT:='3';
  EXCEPTION
    WHEN NO_DATA_FOUND THEN
    IF O_DEBUG_POINT = '1A' THEN
      O_APP_ERROR_CODE:='EM-001';
    END IF;
    
END TCH_EMV_ACK;