create or replace 
PROCEDURE TCH_TIP_PROC(
    I_TERMINAL_SERIAL_NUMBER IN VARCHAR2
  , I_INV_NUMBER IN VARCHAR2
  , I_TXN_COUNT IN VARCHAR2
  , O_SQL_CODE OUT VARCHAR2
  , O_APP_ERROR_CODE OUT VARCHAR2
  , O_DEBUG_POINT OUT VARCHAR2 
  , O_HOST_ID OUT VARCHAR2
  , C_TIP_DATA OUT SYS_REFCURSOR
  , C_EXST_TIP OUT SYS_REFCURSOR
  ) AS 
  
  V_COUNT NUMBER(10):=NULL;
  V_TIP VARCHAR2(1):=NULL;
  V_REQUEST_TYPE VARCHAR2(10):=NULL;
  BEGIN
    O_DEBUG_POINT:='1';
    IF I_TXN_COUNT IS NULL THEN
      BEGIN
        SELECT COUNT(1) INTO V_COUNT FROM TCH_PAYMENT_TXN TPT 
        WHERE TPT.P_INVOICENUMBER = I_INV_NUMBER 
        AND TPT.P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER  
        AND (P_REQUEST_TYPE='SALE' OR P_REQUEST_TYPE = 'SALECOMP' OR P_REQUEST_TYPE='SALECSHBK' OR P_REQUEST_TYPE='CSHBK')
        AND TPT.P_RESPONSE_CODE = '00';
        IF V_COUNT = 0 THEN
          BEGIN
            O_DEBUG_POINT:='1AB';
            SELECT COUNT(1) INTO V_COUNT FROM TCH_PAYMENT_AMEX_TXN TPT 
              WHERE TPT.P_INVOICENUMBER = I_INV_NUMBER 
              AND TPT.P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER  
              AND (P_REQUEST_TYPE='SALE' OR P_REQUEST_TYPE = 'SALECOMP' OR P_REQUEST_TYPE='SALECSHBK' OR P_REQUEST_TYPE='CSHBK')
              AND TPT.P_RESPONSE_CODE = '00';
               
               IF V_COUNT = 0 THEN
                O_DEBUG_POINT:='1A';
                RAISE_APPLICATION_ERROR('-21000','NO DATA FOUND');
              ELSE
                SELECT TPT.P_TIP_APPROVED,TPT.P_REQUEST_TYPE  INTO V_TIP,V_REQUEST_TYPE FROM TCH_PAYMENT_AMEX_TXN TPT 
                  WHERE TPT.P_INVOICENUMBER = I_INV_NUMBER 
                  AND TPT.P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER  
                  AND (P_REQUEST_TYPE='SALE' OR P_REQUEST_TYPE = 'SALECOMP' OR P_REQUEST_TYPE='SALECSHBK' OR P_REQUEST_TYPE='CSHBK') 
                  AND TPT.P_RESPONSE_CODE = '00';
                  IF V_TIP = '1' THEN
                    O_DEBUG_POINT:='1B';
                    RAISE_APPLICATION_ERROR('-21001','ALREADY TIP GIVEN');
                  ELSIF V_REQUEST_TYPE = 'REFUND' OR V_REQUEST_TYPE = 'SALECSHBK' OR V_REQUEST_TYPE = 'CSHBK' THEN
                    O_DEBUG_POINT:='1C';
                    RAISE_APPLICATION_ERROR('-21002','TIP NOT ALLOWED');
                  ELSE
                    OPEN C_TIP_DATA FOR
                      SELECT TPT.* FROM TCH_PAYMENT_AMEX_TXN TPT 
                      WHERE TPT.P_INVOICENUMBER = I_INV_NUMBER 
                      AND TPT.P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER
                      AND (P_REQUEST_TYPE='SALE' OR P_REQUEST_TYPE = 'SALECOMP' OR P_REQUEST_TYPE='SALECSHBK' OR P_REQUEST_TYPE='CSHBK')
                      AND TPT.P_RESPONSE_CODE = '00';
                      
                      O_HOST_ID := 'AMEX';
                  END IF;
              END IF;
            END;
        ELSE
         BEGIN
         -- CHECK FOR ALREADY TIP HAS BEEN GIVEN OR NOT ABD NOT REFUND TRANSACTION
            SELECT TPT.P_TIP_APPROVED,TPT.P_REQUEST_TYPE  INTO V_TIP,V_REQUEST_TYPE FROM TCH_PAYMENT_TXN TPT 
            WHERE TPT.P_INVOICENUMBER = I_INV_NUMBER 
            AND TPT.P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER  
            AND (P_REQUEST_TYPE='SALE' OR P_REQUEST_TYPE = 'SALECOMP' OR P_REQUEST_TYPE='SALECSHBK' OR P_REQUEST_TYPE='CSHBK') 
            AND TPT.P_RESPONSE_CODE = '00';
            
            IF V_TIP = '1' THEN
              O_DEBUG_POINT:='1B';
              RAISE_APPLICATION_ERROR('-21001','ALREADY TIP GIVEN');
            ELSIF V_REQUEST_TYPE = 'REFUND' OR V_REQUEST_TYPE = 'SALECSHBK' OR V_REQUEST_TYPE = 'CSHBK' THEN
              O_DEBUG_POINT:='1C';
              RAISE_APPLICATION_ERROR('-21002','TIP NOT ALLOWED');
            ELSE
              OPEN C_TIP_DATA FOR
                SELECT TPT.* FROM TCH_PAYMENT_TXN TPT 
                WHERE TPT.P_INVOICENUMBER = I_INV_NUMBER 
                AND TPT.P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER  
                AND (P_REQUEST_TYPE='SALE' OR P_REQUEST_TYPE = 'SALECOMP' OR P_REQUEST_TYPE='SALECSHBK' OR P_REQUEST_TYPE='CSHBK')
                AND TPT.P_RESPONSE_CODE = '00';
                
                O_HOST_ID := 'CR-DB';
            END IF;
          END;
        END IF;
      END;
    ELSE
      SELECT COUNT(1) INTO V_COUNT FROM TCH_PAYMENT_TXN TPT 
      WHERE TPT.P_INVOICENUMBER = I_INV_NUMBER 
      AND TPT.P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER 
      AND TPT.P_REQUEST_TYPE = 'SALE'
      AND TPT.P_RESPONSE_CODE = '00';
      IF V_COUNT <> 1 THEN
         O_DEBUG_POINT:='1AB';
         RAISE_APPLICATION_ERROR('-21000','NO DATA FOUND');
      ELSE
       OPEN C_EXST_TIP FOR
        SELECT * FROM TCH_PAYMENT_TXN TPT WHERE TPT.P_INVOICENUMBER = I_INV_NUMBER 
        AND TPT.P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER AND TPT.P_REQUEST_TYPE = 'SALE';
      END IF;
      
    END IF;
    
     O_DEBUG_POINT:='2';
    EXCEPTION
    WHEN NO_DATA_FOUND THEN
      IF O_DEBUG_POINT = '1A' THEN
        O_APP_ERROR_CODE:='T-004';
      ELSIF O_DEBUG_POINT = '1B' THEN
        O_APP_ERROR_CODE:='T-008';
      ELSIF O_DEBUG_POINT = '1C' THEN
        O_APP_ERROR_CODE:='T-007';
      ELSIF O_DEBUG_POINT = '1AB' THEN
       O_APP_ERROR_CODE:='T-111';
      END IF;
    WHEN OTHERS THEN
      IF O_DEBUG_POINT = '1A' THEN
        O_APP_ERROR_CODE:='T-004';
      ELSIF O_DEBUG_POINT = '1B' THEN
        O_APP_ERROR_CODE:='T-008';
      ELSIF O_DEBUG_POINT = '1C' THEN
        O_APP_ERROR_CODE:='T-007';  
      END IF;
    O_SQL_CODE:=SQLCODE;
  END TCH_TIP_PROC;