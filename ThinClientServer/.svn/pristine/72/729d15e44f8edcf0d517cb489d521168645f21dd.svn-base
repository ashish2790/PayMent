create or replace 
PROCEDURE TCH_REVERSAL_WALLET_PROC(
I_TERMINAL_SERIAL_NUMBER IN VARCHAR2,
I_REF_VALUE IN VARCHAR2,
I_INVOICE_NUMBER IN VARCHAR2,
O_DEBUG_POINT OUT VARCHAR2,  
O_TABLE_ID OUT VARCHAR2,  
O_SQL_CODE OUT VARCHAR2,
O_APP_ERROR_CODE OUT VARCHAR2,
C_WALLET_DETAIL OUT SYS_REFCURSOR
)
AS 
V_COUNT NUMBER(20) := NULL;

BEGIN

    O_DEBUG_POINT:='1A'; 

-- GET REVERSAL COUNT 
    --SELECT AC_VALUE INTO O_REV_COUNT FROM TCH_APPL_CONFIG WHERE AC_NAME = 'REVCNT';
-- GET THE ORIGINAL TRANSACTION  
    SELECT COUNT(1) INTO V_COUNT FROM TCH_WALLET_TXN TWT 
    WHERE TWT.W_TERM_SER_NUM = I_TERMINAL_SERIAL_NUMBER 
    AND W_INV_NUMBER = I_INVOICE_NUMBER
    AND W_REQUEST_TYPE <> 'REVERSAL';

    IF V_COUNT <> 1 THEN
    BEGIN
      O_DEBUG_POINT:='1B';
      IF I_INVOICE_NUMBER <> 'N' THEN
        SELECT COUNT(1) INTO V_COUNT FROM TCH_WALLET_TXN 
        WHERE W_TERM_SER_NUM = I_TERMINAL_SERIAL_NUMBER 
        AND W_INV_NUMBER = I_INVOICE_NUMBER
        AND W_REQUEST_TYPE <> 'REVERSAL';
          IF V_COUNT <> 0 THEN
            OPEN C_WALLET_DETAIL FOR
              SELECT * FROM TCH_WALLET_TXN 
              WHERE W_TERM_SER_NUM = I_TERMINAL_SERIAL_NUMBER 
              AND W_INV_NUMBER = I_INVOICE_NUMBER
              AND W_REQUEST_TYPE <> 'REVERSAL'; 
          ELSE 
            O_DEBUG_POINT:='1BB';
            RAISE_APPLICATION_ERROR('-21111','NO DATA FOUND');
          END IF;
      ELSIF I_REF_VALUE  <> 'N' THEN
         SELECT COUNT(1) INTO V_COUNT FROM TCH_WALLET_TXN 
         WHERE W_TERM_SER_NUM = I_TERMINAL_SERIAL_NUMBER 
         AND W_TXN_REF_ID = I_REF_VALUE;
        IF V_COUNT <> 0 THEN
          OPEN C_WALLET_DETAIL FOR
            SELECT * FROM TCH_WALLET_TXN WHERE W_TERM_SER_NUM = I_TERMINAL_SERIAL_NUMBER
            AND W_TXN_REF_ID = I_REF_VALUE
            AND W_REQUEST_TYPE <> 'REVERSAL';
        ELSE 
          O_DEBUG_POINT:='1BA';
          RAISE_APPLICATION_ERROR('-21111','NO DATA FOUND');
        END IF;
      END IF;
     END;
   END IF;
   
O_DEBUG_POINT := '2';
  EXCEPTION
  WHEN NO_DATA_FOUND THEN
    IF O_DEBUG_POINT ='1A' THEN
      O_APP_ERROR_CODE:='R-002';
    ELSIF O_DEBUG_POINT ='1BA' THEN
      O_APP_ERROR_CODE:='R-001';
    ELSIF O_DEBUG_POINT ='1BB' THEN
      O_APP_ERROR_CODE:='R-001';
    END IF;

END TCH_REVERSAL_WALLET_PROC;