create or replace 
PROCEDURE TCH_AUTOSETTLEMENT_PROC
( 
  I_TERMINAL_SERIAL_NUMBER IN VARCHAR2
, O_DEBUG_POINT OUT VARCHAR2
, O_SQL_ERROR_CODE OUT VARCHAR2
, O_APP_ERROR_CODE OUT VARCHAR2
)
AS 
  V_COUNT NUMBER(3):=NULL;
  V_P_ID NUMBER(10):=NULL;

  CURSOR C_PID_LIST IS
    SELECT TTP.P_ID FROM TCH_PAYMENT_TXN TTP JOIN TC_TID_HWSR_MAPPING THM ON TTP.P_TERMINAL_SERIAL_NUMBER = THM.HWSRNO
    WHERE THM.AUTOSETTLEMENT = 'Y';
  
  CURSOR C_BATCH_TERM_LIST IS
    SELECT B_BATCH_NUMBER,B_TERMINAL_SERIAL_NUMBER 
      FROM TCH_BATCH_SUMMARY TBS JOIN TC_TID_HWSR_MAPPING THM ON TBS.B_TERMINAL_SERIAL_NUMBER = THM.HWSRNO 
      WHERE THM.AUTOSETTLEMENT = 'Y'
      GROUP BY B_BATCH_NUMBER,B_TERMINAL_SERIAL_NUMBER;
  
BEGIN
  O_DEBUG_POINT:='1';
  
  SELECT COUNT (DISTINCT P_TERMINAL_SERIAL_NUMBER) INTO V_COUNT FROM TCH_PAYMENT_TXN;
  IF V_COUNT = 0 THEN
    O_DEBUG_POINT :='1A';
    RAISE_APPLICATION_ERROR('-21313','NO DATA FOUND FOR SETTLEMENT');
  ELSE
    BEGIN
      O_DEBUG_POINT :='1B';
  -- COPY DATA FROM PAYMENT TABLE TO SETTLEMENT TABLE
      INSERT INTO TCH_SETTLED_PAYMENT_TXN SELECT TTP.* FROM TCH_PAYMENT_TXN TTP
        JOIN TC_TID_HWSR_MAPPING THM ON TTP.P_TERMINAL_SERIAL_NUMBER = THM.HWSRNO
        WHERE THM.AUTOSETTLEMENT = 'Y' 
        AND TTP.P_RESPONSE_CODE = '00' 
        AND TTP.P_REQUEST_TYPE <> 'REVERSAL' 
        AND TTP.P_REQUEST_TYPE <> 'TIP' 
        AND TTP.P_REQUEST_TYPE <> 'VOIDREFUND'
        AND TTP.P_REQUEST_TYPE <> 'VOID';    
        O_DEBUG_POINT :='1BA';
      INSERT INTO TCH_SETTLED_PAYMENT_RT_VT_TT SELECT TTP.* FROM TCH_PAYMENT_TXN TTP 
        JOIN TC_TID_HWSR_MAPPING THM ON TTP.P_TERMINAL_SERIAL_NUMBER = THM.HWSRNO
        WHERE THM.AUTOSETTLEMENT = 'Y' 
        AND (
              TTP.P_RESPONSE_CODE <> '00' 
              OR TTP.P_REQUEST_TYPE = 'REVERSAL' 
              OR TTP.P_REQUEST_TYPE = 'TIP' 
              OR TTP.P_REQUEST_TYPE = 'VOID'
            );
        O_DEBUG_POINT :='1BC';
       FOR T IN C_PID_LIST LOOP
        UPDATE TCH_SETTLED_PAYMENT_TXN SET P_SETTLEMENT_FLAG = 'Y' WHERE P_ID = T.P_ID;
        DELETE FROM TCH_PAYMENT_TXN WHERE P_ID = T.P_ID;
       END LOOP;
       O_DEBUG_POINT :='1BD';
       FOR P IN C_BATCH_TERM_LIST LOOP
        UPDATE TCH_BATCH_SUMMARY SET B_CLOSE_DATE = CURRENT_TIMESTAMP 
        WHERE B_TERMINAL_SERIAL_NUMBER = P.B_TERMINAL_SERIAL_NUMBER 
        AND B_BATCH_NUMBER = P.B_BATCH_NUMBER
        AND B_CLOSE_DATE IS NULL;
       END LOOP;
    END;
  END IF;
   O_DEBUG_POINT :='2';
  EXCEPTION
  WHEN NO_DATA_FOUND THEN
    IF O_DEBUG_POINT = '1A' THEN
      O_APP_ERROR_CODE:='A-001';
    END IF;
  WHEN OTHERS THEN
    IF O_DEBUG_POINT = '1A' THEN
      O_APP_ERROR_CODE:='A-001';
    END IF;
  O_SQL_ERROR_CODE := SQLCODE;
  
END TCH_AUTOSETTLEMENT_PROC;