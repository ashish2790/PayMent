create or replace 
PROCEDURE TCH_EMI_DETAILS_PROC (
  I_TERMINAL_SERIAL_NUMBER IN VARCHAR2
, I_BIN_CODE IN VARCHAR2
, I_PROGRAM_CODE IN VARCHAR2
, I_TENURE_CODE IN VARCHAR2
, I_MFG_CODE IN VARCHAR2
, I_PRODUCT_CODE IN VARCHAR2
, O_SQL_CODE OUT VARCHAR2
, O_APP_ERROR_CODE OUT VARCHAR2
, O_DEBUG_POINT OUT VARCHAR2
, C_PROGRAM_DETAIL OUT SYS_REFCURSOR
, C_TENURE_DETAIL OUT SYS_REFCURSOR
, C_CASHBACK_DETAIL OUT SYS_REFCURSOR
, C_PRODUCT_DETAIL OUT SYS_REFCURSOR
, C_AMOUNT_DETAILS OUT SYS_REFCURSOR
) AS 

V_COUNT NUMBER(4):=NULL;
V_MID VARCHAR2(20):=NULL;
V_TID VARCHAR2(20):=NULL;

BEGIN
-- GET THE MID TID DETAILS
    O_DEBUG_POINT:='1';
    BEGIN 
    SELECT COUNT(distinct THM.MID),THM.MID,THM.TID INTO V_COUNT,V_MID, V_TID FROM 
    TC_TERM_PARAMETER TTP JOIN TC_TID_HWSR_MAPPING THM ON TTP.MID = THM.MID 
    AND TTP.TID = THM.TID JOIN TC_ME_PARAMETER TMP ON  TMP.MEPARAMID = TTP.MEPARAMID 
    AND THM.STATUS = 'A'
    WHERE THM.HWSRNO = I_TERMINAL_SERIAL_NUMBER GROUP BY THM.MID,THM.TID;
        
        EXCEPTION
        WHEN NO_DATA_FOUND THEN
        IF O_DEBUG_POINT ='1' THEN
          O_DEBUG_POINT := '1A';
          V_COUNT := 0;
        END IF;
    END;
    IF V_COUNT = 0 THEN
      O_DEBUG_POINT:='1A';
      RAISE_APPLICATION_ERROR('-21211','NO RECORD FOUND');
    END IF;
    
   O_DEBUG_POINT:='2';
   
  IF I_PROGRAM_CODE = 'A' THEN
-- GET PROGRAM CODE
    BEGIN
      O_DEBUG_POINT:='2A';
      
        --SELECT COUNT (DISTINCT TE001.PROGRAMCODE) INTO V_COUNT FROM TC_EMI_TABLECODE_001 TE001 JOIN TC_EMI_TABLECODE_005 TE005 ON TE001.PROGRAMCODE = TE005.PROGRAM_CODE
              --WHERE TE005.MERCHANT_ID = V_MID AND  TE005.TERMINAL_ID = V_TID;
        SELECT COUNT (DISTINCT TE001.PROGRAMCODE) INTO V_COUNT FROM TC_EMI_TABLECODE_001 TE001 
              LEFT JOIN TC_EMI_TABLECODE_005 TE005 ON TE001.PROGRAMCODE = TE005.PROGRAM_CODE
              LEFT JOIN TC_EMI_TABLECODE_004 TE004 ON TE001.PROGRAMCODE = TE004.PROGRAM_CODE 
              WHERE TE005.MERCHANT_ID = V_MID AND TE005.TERMINAL_ID = V_TID 
              AND TE004.MANUFACTURER_CODE IS NULL AND TE004.MANUFACTURER_NAME IS NULL
              AND TO_DATE(SYSDATE,'DD-MON-YY') BETWEEN TO_DATE(TE001.STARTDATE,'DD-MON-YY') AND TO_DATE(TE001.ENDDATE,'DD-MON-YY')
              AND TE005.STATUS='A';
      
      IF V_COUNT <> 0 THEN
        BEGIN  
        OPEN C_AMOUNT_DETAILS FOR
          SELECT DISTINCT TE002.ISSUER_BIN_CODE,TE002.EMI_MAX_TRN_CAP,TE002.EMI_MIN_TRN_CAP from 
          TC_EMI_TABLECODE_005 TE005 RIGHT OUTER JOIN TC_EMI_TABLECODE_003 TE003 
          ON TE005.PROGRAM_CODE = TE003.PROGRAM_CODE RIGHT OUTER  JOIN 
          TC_EMI_TABLECODE_002 TE002 ON TE003.BIN_CODE = TE002.ISSUER_BIN_CODE
          WHERE TE005.MERCHANT_ID = V_MID AND TE005.TERMINAL_ID = V_TID;
        
          OPEN C_PROGRAM_DETAIL FOR
            --SELECT DISTINCT TE001.PROGRAMCODE, TE001.PROGRAMSHORTNAME, TE001.PROGRAMNAME,TE001.STARTDATE,TE001.ENDDATE,
              --TE001.PRODUCTFLAG,TE005.ACQUIRING_BANK_CODE FROM TC_EMI_TABLECODE_001 TE001 JOIN TC_EMI_TABLECODE_005 TE005
              -- ON TE001.PROGRAMCODE = TE005.PROGRAM_CODE
              --WHERE TE005.MERCHANT_ID = V_MID AND  TE005.TERMINAL_ID = V_TID;
        SELECT DISTINCT TE001.PROGRAMCODE, TE001.PROGRAMSHORTNAME, TE001.PROGRAMNAME, TE001.STARTDATE, TE001.ENDDATE,
              TE001.PRODUCTFLAG, TE005.ACQUIRING_BANK_CODE FROM TC_EMI_TABLECODE_001 TE001 
              LEFT JOIN TC_EMI_TABLECODE_005 TE005 ON TE001.PROGRAMCODE = TE005.PROGRAM_CODE
              LEFT JOIN TC_EMI_TABLECODE_004 TE004 ON TE001.PROGRAMCODE = TE004.PROGRAM_CODE 
              WHERE TE005.MERCHANT_ID = V_MID AND TE005.TERMINAL_ID = V_TID 
              AND TE004.MANUFACTURER_CODE IS NULL AND TE004.MANUFACTURER_NAME IS NULL
              AND TO_DATE(SYSDATE,'DD-MON-YY') BETWEEN TO_DATE(TE001.STARTDATE,'DD-MON-YY') AND TO_DATE(TE001.ENDDATE,'DD-MON-YY')
              AND TE005.STATUS='A';

        END;
      ELSE 
        O_DEBUG_POINT:='2AA';
        RAISE_APPLICATION_ERROR('-21211','NO PROGRAMS FOUND');
      END IF;
    END;
  ELSIF I_TENURE_CODE = 'A' THEN
    BEGIN
-- GET TENURE RELATED INFO BASED ON THE PROGRAM CODE
     O_DEBUG_POINT:='2B';
     
     SELECT COUNT(1) INTO V_COUNT FROM 
     TC_EMI_TABLECODE_003 TE003 JOIN TC_EMI_TABLECODE_002 TE002 ON TE003.ISSUER_BANK_CODE = TE002.ISSUER_BANK_CODE 
     AND TE003.BIN_CODE = TE002.ISSUER_BIN_CODE
     WHERE TE003.PROGRAM_CODE = I_PROGRAM_CODE 
     and TE002.ISSUER_BIN_CODE = I_BIN_CODE;
     
     IF V_COUNT <> 0 THEN
      BEGIN
          O_DEBUG_POINT:='2BA';
          OPEN C_TENURE_DETAIL FOR
            SELECT  DISTINCT TE003.PROGRAM_CODE, TE003.ISSUER_BANK_CODE, TE003.TENURE_CODE, TE003.INTERESTS_RATE, TE003.DISCOUNT_FLAG,
            TE003.DISCOUNT_PERCENT, TE003.DISCOUNT_CAP, TE003.DISCOUNT_FLAT_AMOUNT, TE003.PROCESS_FEE_PERCENT,TE003.PROCESS_FEE_AMT,TE003.ISS_DISCLIMER_CODE,
            TE002.EMI_MIN_TRN_CAP,TE002.EMI_MAX_TRN_CAP,TE002.ISSUERDISCLAIMER,TE002.ACQUIERERDISCLAIMER, TE002.EMI_CAL_METHOD, TE002.ISSUER_BANK_NAME
            FROM TC_EMI_TABLECODE_003 TE003 JOIN TC_EMI_TABLECODE_002 TE002 ON TE003.ISSUER_BANK_CODE = TE002.ISSUER_BANK_CODE 
            AND TE003.BIN_CODE = TE002.ISSUER_BIN_CODE
            WHERE TE003.PROGRAM_CODE = I_PROGRAM_CODE 
            and TE002.ISSUER_BIN_CODE = I_BIN_CODE ORDER BY TO_NUMBER(TE003.TENURE_CODE);
            
          O_DEBUG_POINT:='2BB';
          IF I_PRODUCT_CODE IS NOT NULL AND I_MFG_CODE IS NOT NULL THEN
          OPEN C_PRODUCT_DETAIL FOR
            SELECT DISTINCT PRODUCTMINMRP, PRODUCTMAXMRP,
            MANUFACTURERDESCLAIMER,MANUFACTURER_NAME,PRODUCT_DESCRIPTION,PRODUCT_CODE,MANUFACTURER_CODE FROM TC_EMI_TABLECODE_004 
            WHERE PROGRAM_CODE = I_PROGRAM_CODE 
            AND PRODUCT_CODE = I_PRODUCT_CODE 
            AND MANUFACTURER_CODE = I_MFG_CODE;
          ELSE
            OPEN C_PRODUCT_DETAIL FOR
            SELECT DISTINCT PRODUCTMINMRP, PRODUCTMAXMRP,
            MANUFACTURERDESCLAIMER,MANUFACTURER_NAME,PRODUCT_DESCRIPTION,PRODUCT_CODE,MANUFACTURER_CODE FROM TC_EMI_TABLECODE_004 
            WHERE PROGRAM_CODE = I_PROGRAM_CODE AND MANUFACTURER_CODE IS NULL;
          END IF;
            
          O_DEBUG_POINT:='2BC';
          OPEN C_CASHBACK_DETAIL FOR
            SELECT TE006.PROGRAM_CODE, TE006.TENURE_CODE, TE006.CASH_BACK_PROVIDER_CODE, 
            TE006.CASH_BACK_INDICATOR, TE006.CASH_BACK_FLAG,TE006.SUBVENTION_PER,TE006.CASH_BACK_MIN_AMT_LMT,
            TE006.CASH_BACK_PERCENT, TE006.CASH_BACK_CAP, TE006.CASH_BACK_FLAT_AMOUNT,TE006.TENURE_TYPE FROM TC_EMI_TABLECODE_006 TE006 
            WHERE TE006.PROGRAM_CODE = I_PROGRAM_CODE;
      END;
     ELSE
      O_DEBUG_POINT:='2BA';
      RAISE_APPLICATION_ERROR('-21444','NO TENURES FOUND FOR CURRENT PROGRAM');
    END IF;
   END;
   ELSE 
    BEGIN 
    
      OPEN C_CASHBACK_DETAIL FOR
        SELECT TE006.PROGRAM_CODE, TE006.TENURE_CODE, TE006.CASH_BACK_PROVIDER_CODE, 
        TE006.CASH_BACK_INDICATOR, TE006.CASH_BACK_FLAG,TE006.SUBVENTION_PER,TE006.CASH_BACK_MIN_AMT_LMT,
        TE006.CASH_BACK_PERCENT, TE006.CASH_BACK_CAP, TE006.CASH_BACK_FLAT_AMOUNT,TE006.TENURE_TYPE FROM TC_EMI_TABLECODE_006 TE006 
        WHERE TE006.PROGRAM_CODE = I_PROGRAM_CODE 
        AND TE006.TENURE_CODE = I_TENURE_CODE;
        
    END;
  END IF;
    O_DEBUG_POINT:='3';
  
  EXCEPTION
  WHEN NO_DATA_FOUND THEN
    IF O_DEBUG_POINT = '1A' THEN
      O_APP_ERROR_CODE:='S-009';
   ELSIF O_DEBUG_POINT = '2AA' THEN
      O_APP_ERROR_CODE:='E-001';
   ELSIF O_DEBUG_POINT = '2BA' THEN
      O_APP_ERROR_CODE:='E-002';
    END IF;
  WHEN OTHERS THEN
    IF O_DEBUG_POINT = '1A' THEN
      O_APP_ERROR_CODE:='S-009';
    ELSIF O_DEBUG_POINT = '2AA' THEN
      O_APP_ERROR_CODE:='E-001';
    ELSIF O_DEBUG_POINT = '2BA' THEN
      O_APP_ERROR_CODE:='E-002';
    END IF;
  O_SQL_CODE := SQLCODE;
 
END TCH_EMI_DETAILS_PROC;