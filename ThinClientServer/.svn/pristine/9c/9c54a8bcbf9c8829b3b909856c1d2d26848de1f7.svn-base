create or replace 
PROCEDURE TCH_DETAIL_BTH_REPORT_PROC1 (
  I_TERMINAL_SERIAL_NUMBER IN VARCHAR2
, I_TID IN VARCHAR2
, I_MID IN VARCHAR2
, I_HOST_ID IN VARCHAR2
, I_BATCH_NUMBER IN VARCHAR2
, I_OFFSET IN VARCHAR2
, I_DES_PARAM IN VARCHAR2
, O_BATCH_NUMBER OUT VARCHAR2
, O_SQL_CODE OUT VARCHAR2
, O_APP_ERROR_CODE OUT VARCHAR2
, O_DEBUG_POINT OUT VARCHAR2
, O_TOTAL_COUNT OUT VARCHAR2
, O_FINAL_COUNT OUT VARCHAR2
, C_DETAIL_REPORT_DATA OUT SYS_REFCURSOR
, C_DETAIL_REPORT_TABLE_DATA OUT SYS_REFCURSOR
)
AS 
V_COUNT VARCHAR2(20):=NULL;
V_DATE VARCHAR2(50):=NULL;
V_REF_DAY VARCHAR2(3):=NULL;
V_DATE_DIFF VARCHAR2(20):=NULL;
BEGIN
    O_BATCH_NUMBER := I_BATCH_NUMBER;
-- CHECK ERROR CONIDTION TO BE SEND OR NOT BASED ON THE COUNT FROM EACH TABLE
    O_DEBUG_POINT :='1A';
    SELECT SUM(V_COUNT) ,SUM(O_TOTAL_COUNT) INTO V_COUNT, O_TOTAL_COUNT FROM (
      SELECT COUNT(1) AS V_COUNT,COUNT(1) AS O_TOTAL_COUNT FROM TCH_SETTLED_PAYMENT_TXN 
        WHERE P_RESPONSE_CODE = '00' 
        AND P_REQUEST_TYPE <> 'TIP'
        AND P_REQUEST_TYPE <> 'REVERSAL'
        AND P_TERMINALID = I_TID
        AND P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER
        AND P_BATCH_NUMBER = I_BATCH_NUMBER
        
        UNION ALL
        
      SELECT COUNT(1) AS V_COUNT,COUNT(1) AS O_TOTAL_COUNT FROM TCH_SETTLED_PAYMENT_RT_VT_TT 
        WHERE P_RESPONSE_CODE = '00' 
        AND P_REQUEST_TYPE <> 'TIP'
        AND P_REQUEST_TYPE <> 'REVERSAL'
        AND P_TERMINALID = I_TID
        AND P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER
        AND P_BATCH_NUMBER = I_BATCH_NUMBER
        
      );
        IF V_COUNT = 0 THEN
          O_DEBUG_POINT :='1D';
          O_FINAL_COUNT:='0';
          RAISE_APPLICATION_ERROR('-20155','NO MAPPING FOUND');
        END IF;
        
        SELECT MAX(B_CLOSE_DATE) INTO V_DATE FROM TCH_BATCH_SUMMARY 
        WHERE B_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER
        AND B_BATCH_NUMBER = I_BATCH_NUMBER; 
-- IF DATE EXCEEDS FROM SET DATE THEN REJECT WITH PROPER ERROR        
        IF V_DATE IS NOT NULL THEN
          BEGIN
            O_DEBUG_POINT:='1DE';
              V_DATE:=SUBSTR(V_DATE,0,9);
             SELECT EXTRACT(DAY FROM DIFF) DAYS  INTO V_DATE_DIFF FROM 
             (
                SELECT 
                  TO_TIMESTAMP_TZ(TRUNC(CURRENT_TIMESTAMP), 'dd-mon-yyyy') -
                  TO_TIMESTAMP_TZ(V_DATE, 'dd-mon-yyyy') DIFF
                FROM DUAL
              );
              O_DEBUG_POINT:='1E';
              -- GET THE VALUES FOR DAYS FOR WHICH DETAIL REPORT SHOULD GOT FETCHED
              SELECT AC_VALUE INTO V_REF_DAY FROM TCH_APPL_CONFIG WHERE AC_NAME = 'DETRESCT';
              IF TO_NUMBER(V_DATE_DIFF) > TO_NUMBER(V_REF_DAY) THEN
                O_APP_ERROR_CODE :='D-404';
                RAISE_APPLICATION_ERROR(-20111,'NUMBER OF DAYS EXCEED MAX DAYS 7');
              END IF;
          END;
        END IF;
        
    --OFFSET I_OFFSET ROWS FETCH NEXT 10 ROWS ONLY;
    IF I_DES_PARAM <> 1 THEN 
      IF O_TOTAL_COUNT >= 200 THEN
        O_DEBUG_POINT := '1BA';
        O_FINAL_COUNT:='0';
        RAISE_APPLICATION_ERROR('-21212','NO OF RECORDS MORE THAN 100');
      END IF;
    END IF;
    
--CHECK CONDITION FOR COUNTINUTY FLAG
  IF O_TOTAL_COUNT <> 0 THEN
    O_TOTAL_COUNT := O_TOTAL_COUNT - I_OFFSET;
    IF O_TOTAL_COUNT < 20 THEN
      O_TOTAL_COUNT := '0';
    ELSE
      O_TOTAL_COUNT := '1';
    END IF;
  END IF;
  
-- GET DETAIL REPORT DATA FROM PAYMENT TABLE IN THE PACKET OF 10
    BEGIN 
    O_DEBUG_POINT:='1E';
     OPEN C_DETAIL_REPORT_DATA FOR
      SELECT P_REQUEST_TYPE , P_INVOICENUMBER, P_AUTH_ID, P_LAST_FOUR_DIGIT, 
        P_EXPIRYDATE, P_ORIGINAL_AMOUNT, P_CARD_LABEL, P_TIP_APPROVED
        FROM TCH_SETTLED_PAYMENT_TXN 
        WHERE P_RESPONSE_CODE = '00' 
        AND P_REQUEST_TYPE <> 'TIP'
        AND P_REQUEST_TYPE <> 'REVERSAL'
        AND P_TERMINALID = I_TID
        AND P_BATCH_NUMBER = I_BATCH_NUMBER
        AND P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER 
        
        UNION ALL
        
      SELECT P_REQUEST_TYPE , P_INVOICENUMBER, P_AUTH_ID, P_LAST_FOUR_DIGIT, 
        P_EXPIRYDATE, P_ORIGINAL_AMOUNT, P_CARD_LABEL, P_TIP_APPROVED
        FROM TCH_SETTLED_PAYMENT_RT_VT_TT 
        WHERE P_RESPONSE_CODE = '00' 
        AND P_REQUEST_TYPE <> 'REVERSAL'
        AND P_TERMINALID = I_TID
        AND P_BATCH_NUMBER = I_BATCH_NUMBER
        AND P_TERMINAL_SERIAL_NUMBER = I_TERMINAL_SERIAL_NUMBER  
        ORDER BY P_INVOICENUMBER
      OFFSET I_OFFSET ROWS FETCH NEXT 20 ROWS ONLY;
    END;
  O_DEBUG_POINT:='1H';
-- GET DETAIL TABLE INFORMATION
  OPEN C_DETAIL_REPORT_TABLE_DATA FOR
    SELECT D_DISPLAY_MSG_PARAM,D_COLUMN_NAME FROM TCH_DETAIL_REPORT ORDER BY D_DISPLAY_SEQ_NUMBER;
    
  O_BATCH_NUMBER := LPAD(O_BATCH_NUMBER,6,'0');
  O_DEBUG_POINT := '2';
    EXCEPTION
    WHEN NO_DATA_FOUND THEN
      IF O_DEBUG_POINT = '1D' THEN
        O_FINAL_COUNT:='0';
        O_APP_ERROR_CODE :='D-402';
      END IF;
    WHEN OTHERS THEN
      IF O_DEBUG_POINT = '1BA' THEN
        O_FINAL_COUNT:='0';
        O_APP_ERROR_CODE :='D-403';
     ELSIF O_DEBUG_POINT = '1D' THEN
        O_FINAL_COUNT:='0';
        O_APP_ERROR_CODE :='D-402';
      END IF;
  O_SQL_CODE := SQLCODE;
END TCH_DETAIL_BTH_REPORT_PROC1;